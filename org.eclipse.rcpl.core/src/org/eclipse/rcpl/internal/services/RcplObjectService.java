/*******************************************************************************
 * Copyright (c) 2003 - 2014 Ramin Assisi and others.
 * All rights reserved. This program and the accompanying materials 
 * are made available under the terms of the Common Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/cpl-v10.html
 * 
 * Contributors:
 *     Ramin Assisi - initial implementation
 *******************************************************************************/

package org.eclipse.rcpl.internal.services;

import java.math.BigInteger;

import org.eclipse.rcpl.ICommand;
import org.eclipse.rcpl.IEditor;
import org.eclipse.rcpl.RcplCommand;
import org.eclipse.rcpl.Rcpl;
import org.eclipse.rcpl.internal.util.JOUtil;
import org.openxmlformats.schemas.wordprocessingml.x2006.main.CTBorder;
import org.openxmlformats.schemas.wordprocessingml.x2006.main.CTPBdr;

/**
 * @author eclipse
 * 
 */
public class RcplObjectService extends RcplService {

	// @SuppressWarnings("unused")
	// private static final Logger LOGGER = LoggerFactory
	// .getLogger(JOObjectService.class);

	public RcplObjectService() {
		super();
	}

	@Override
	public Object doExecute(ICommand command) throws Exception {

		// if (getId(command).indexOf("actions/object/rotate_90_clockwise") !=
		// -1) { //$NON-NLS-1$
		// rotate(90);
		// return true;
		// }
		//
		// if (getId(command).indexOf("actions/object/rotate_90_anticlockwise")
		// != -1) { //$NON-NLS-1$
		// rotate(-90);
		// return true;
		// }
		//
		// if (getId(command).indexOf("actions/object/flip_horizontally") != -1)
		// { //$NON-NLS-1$
		// // flip(SWT.HORIZONTAL);
		// return true;
		// }
		//
		// if (getId(command).indexOf("actions/object/flip_vertically") != -1) {
		// //$NON-NLS-1$
		// // flip(JO.VERTICAL);
		// return true;
		// }
		//
		// if (getId(command).indexOf("actions/object/shadow_style_") != -1) {
		// //$NON-NLS-1$
		// setShadow(command);
		// return true;
		// }
		//
		// if (getId(command).indexOf("actions/object/border_bottom") != -1) {
		// //$NON-NLS-1$
		// Boolean sel = (Boolean) command.getNewData()[0];
		// // setBorder(command, SWT.BOTTOM, sel);
		// return true;
		// }
		// if (getId(command).indexOf("actions/object/border_top") != -1) {
		// //$NON-NLS-1$
		// Boolean sel = (Boolean) command.getNewData()[0];
		// // setBorder(command, SWT.TOP, sel);
		// return true;
		// }
		// if (getId(command).indexOf("actions/object/border_left") != -1) {
		// //$NON-NLS-1$
		// Boolean sel = (Boolean) command.getNewData()[0];
		// setBorder(command, JO.LEFT, sel);
		// return true;
		// }
		// if (getId(command).indexOf("actions/object/border_right") != -1) {
		// //$NON-NLS-1$
		// Boolean sel = (Boolean) command.getNewData()[0];
		// setBorder(command, JO.RIGHT, sel);
		// return true;
		// }
		// if (getId(command).indexOf("actions/object/border_all") != -1) {
		// //$NON-NLS-1$
		// Boolean sel = (Boolean) command.getNewData()[0];
		// // setBorder(command, SWT.ALL, sel);
		// return true;
		// }

		// if (getId(command)
		// .indexOf("actions/object/z_order_send_to_back") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] { JOAction.Z_ORDER_SEND_TO_BACK2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		// if (getId(command)
		// .indexOf("actions/object/z_order_bring_forward") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] { JOAction.Z_ORDER_BRING_FORWARD2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		// if (getId(command)
		// .indexOf("actions/object/z_order_in_front_of_text") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_BRING_IN_FRONT_OF_TEXT2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		// if (getId(command)
		// .indexOf("actions/object/z_order_bring_to_front") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] { JOAction.Z_ORDER_BRING_TOFRONT2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		//
		// if (getId(command)
		// .indexOf("actions/object/z_order_send_backward") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] { JOAction.Z_ORDER_SEND_BACKWARD2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		// if (getId(command)
		// .indexOf("actions/object/z_order_send_behind_text") != -1) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_SEND_BEHIND_TEXT2,
		// JOUtil.getEditor().getSelectedFigure() });
		// return getContextMenuGeneralService().doActionPerformed(command);
		// }
		//
		// if (match(command, "word/actions/object/line_width")) { //$NON-NLS-1$
		//
		// return true;
		// }
		//
		// if (match(command, "word/actions/object/page_color")) { //$NON-NLS-1$
		// editorFigure.getDocument().getBackground()
		// .set(editorFigure.getActualBackgroundColor());
		// editorFigure.repaint();
		// return true;
		// }
		//
		// for (IMovableFeedbackFigure mff0 : editorFigure
		// .getMovableFeebackFigures()) {
		// JOMoveFeedbackFigure mff = (JOMoveFeedbackFigure) mff0;
		// IFigure selectedFigure = (IFigure) mff.getMovableFigure();
		// if (match(command, "actions/object/z_order_bring_to_front")) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_BRING_TOFRONT2, selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// } else if (match(command, "actions/object/fill")) { //$NON-NLS-1$
		// getColorService().setSelectedObjectColor(
		// editorFigure.getActualForgroundColor(),
		// editorFigure.getActualBackgroundColor(), 2);
		// return true;
		// } else if (match(command, "actions/object/foreground_color")) {
		// //$NON-NLS-1$
		// getColorService().setSelectedObjectColor(
		// editorFigure.getActualForgroundColor(),
		// editorFigure.getActualBackgroundColor(), 1);
		// return true;
		// } else if (match(command, "actions/object/line_width")) {
		// //$NON-NLS-1$
		// int sel = (Integer) command.getNewData()[0];
		// switch (sel) {
		// case 0:
		// setLineWidth(1);
		// break;
		// case 1:
		// setLineWidth(2);
		// break;
		// case 2:
		// setLineWidth(3);
		// break;
		// }
		// return true;
		// } else if (match(command, "actions/object/z_order_send_to_back")) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_SEND_TO_BACK2, selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// } else if (match(command, "actions/object/z_order_bring_forward")) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_BRING_FORWARD2, selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// } else if (match(command,
		// "actions/object/z_order_bring_in_front_of_text")) { //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_BRING_IN_FRONT_OF_TEXT2,
		// selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// } else if (match(command, "actions/object/z_order_send_backward")) {
		// //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_SEND_BACKWARD2, selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// } else if (match(command, "actions/object/z_order_send_behind_text"))
		// { //$NON-NLS-1$
		// command.setNewData(new Object[] {
		// JOAction.Z_ORDER_SEND_BEHIND_TEXT2, selectedFigure });
		// getContextMenuGeneralService().doActionPerformed(command);
		// return true;
		// }
		// }
		return false;
	}

	/**
	 * @param type
	 */
	@SuppressWarnings({ "deprecation", "static-access" })
	private void flip(int type) {
		// initSelectedObjects();
		// JOEditorFigure ef = JOUtil.getEditor();
		// for (IMovableFeedbackFigure mff0 : ef.getMovableFeebackFigures()) {
		// JOMoveFeedbackFigure mff = (JOMoveFeedbackFigure) mff0;
		// IFigure selectedFigure = (IFigure) mff.getMovableFigure();
		// if (selectedFigure instanceof JODrawingFigure) {
		// JODrawingFigure df = (JODrawingFigure) selectedFigure;
		// if (df.getDrawing().getSvg() != null) {
		// CTDrawing ctDrawing = (CTDrawing) df.getDrawing()
		// .getXmlObject();
		// CTAnchor[] anchors = ctDrawing.getAnchorArray();
		// for (CTAnchor ctAnchor : anchors) {
		// CTGraphicalObject graphicalObject = ctAnchor
		// .getGraphic();
		// CTGraphicalObjectData gData = null;
		// if (graphicalObject != null) {
		// gData = graphicalObject.getGraphicData();
		// }
		// XmlObject[] pics = df.getDrawing().selectPath(gData,
		// "w", //$NON-NLS-1$
		// JO.NS_PICTURE, "pic"); //$NON-NLS-1$
		// for (XmlObject pic : pics) {
		// if (pic instanceof CTPicture) {
		// CTPicture picture = (CTPicture) pic;
		// CTShapeProperties shapeProperties = picture
		// .getSpPr();
		// if (type == SWT.HORIZONTAL) {
		// if (shapeProperties.getXfrm() != null
		// && shapeProperties.getXfrm()
		// .getFlipH()) {
		// shapeProperties.getXfrm().setFlipH(
		// false);
		// } else {
		// shapeProperties.getXfrm()
		// .setFlipH(true);
		// }
		// } else {
		// if (shapeProperties.getXfrm() != null
		// && shapeProperties.getXfrm()
		// .getFlipV()) {
		// shapeProperties.getXfrm().setFlipV(
		// false);
		// } else {
		// shapeProperties.getXfrm()
		// .setFlipV(true);
		// }
		//
		// }
		// }
		// break;
		// }
		// }
		// df.getDrawing().updateFromXml();
		// df.getDrawing().getSvg(false, true)
		// .createImage(true, false);
		// df.repaint();
		// }
		// }
		// }
	}

	/**
	 * @param degree
	 */
	private void rotate(double degree) {
		// initSelectedObjects();
		// JOEditorFigure ef = JOUtil.getEditor();
		// for (IMovableFeedbackFigure mff0 : ef.getMovableFeebackFigures()) {
		// JOMoveFeedbackFigure mff = (JOMoveFeedbackFigure) mff0;
		// double rot = mff.getRotation();
		// rot += degree;
		// mff.setRotation(rot);
		// mff.getMovableFigure().setRotation(rot);
		// mff.getMovableFigure().rotate();
		// mff.refresh();
		// mff.getMovableFigure().repaint();
		// mff.repaint();
		// }
	}

	/**
	 * @param fg
	 */
	public void setLineWidth(int width) {
		// initSelectedObjects();
		// JOEditorFigure ef = JOUtil.getEditor();
		// for (IMovableFeedbackFigure mff0 : ef.getMovableFeebackFigures()) {
		// JOMoveFeedbackFigure mff = (JOMoveFeedbackFigure) mff0;
		// IFigure selectedFigure = (IFigure) mff.getMovableFigure();
		// if (selectedFigure instanceof JODrawingFigure) {
		// JODrawingFigure df = (JODrawingFigure) selectedFigure;
		// df.getDrawing().setBorderWidth(width * 10);
		// df.getDrawing().getLayoutFigure().repaint();
		// }
		// }
		// // ---------- paragraphs
		// -----------------------------------------------
		//
		// for (JOObject l : getDocument().getLayoutObjects()) {
		// if (l instanceof JOParagraph) {
		// JOParagraph par = (JOParagraph) l;
		// JOParagraphFigure figure = par.getFigure();
		// simulateSelection(figure);
		// if (figure.hasSelection()) {
		// createChangeCommand(par);
		// JOService.getParagraphService().updateStyledText(par,
		// figure.getStyledText());
		// figure.getStyledText().getStyledTextUtil()
		// .setForegoundColor(fg);
		// par.setDirty(true);
		// JOService.getParagraphService().updateParagraph(
		// figure.getStyledText(), par);
		// figure.markAllCharactersDirty();
		// figure.repaint();
		// finalizeCommand();
		// if (selectionSimulation) {
		// break;
		// }
		// }
		// }
		// }
		// finalizeSelectedObjects();
	}

	@SuppressWarnings("hiding")
	private void setShadow(RcplCommand command) {
		Rcpl.profile();
		// initSelectedObjects();

		// for (JOObject l : JOUtil
		// .getEditor()
		// .getDocument()
		// .getLayoutObjects()
		// .toArray(
		// new JOObject[JOUtil.getEditor().getDocument()
		// .getLayoutObjects().size()])) {
		// if (l instanceof JOParagraph) {
		// JOParagraph par = (JOParagraph) l;
		// if (getEditorFigure().getSelectedParagraphFigure()
		// .getParagraph() != par
		// && !par.getFigure().hasSelection()) {
		// continue;
		// }
		// IParagraphFigure parF = par.getFigure();
		// boolean selectionSimulation = simulateSelection(parF);
		//
		// createChangeCommand(par, command.getEntry());
		//
		// int start = parF.getStartOffset();
		// int end = parF.getEndOffset();
		// if (start == end) {
		// start = 0;
		// end = parF.getStyledText().getCharCount();
		// }
		// JOStyle lastStyle = null;
		// for (int i = start; i < end; i++) {
		// if (par.getXmlObject() instanceof CTP) {
		// JOStyle style = (JOStyle) par.findStyleAtOffset(i);
		// if (style != null && style != lastStyle) {
		// lastStyle = style;
		// CTR run = ((JOStyle) par.findStyleAtOffset(i))
		// .getCtr();
		// if (run.isSetRPr() && run.getRPr().isSetShadow()) {
		// run.getRPr().unsetShadow();
		// style.setShadow(null);
		// } else {
		// CTRPr rpr = run.isSetRPr() ? run.getRPr() : run
		// .addNewRPr();
		// CTOnOff shadow = rpr.addNewShadow();
		// shadow.setVal(STOnOff.TRUE);
		// style.setShadow(shadow);
		// }
		// }
		// }
		// }
		// if (selectionSimulation) {
		// parF.unselect();
		// }
		// // par.updateFromXml();
		// parF.markAllCharactersDirty();
		// parF.repaint();
		// }
		// }

		// finalizeCommand();
	}

	/**
	 * @param command
	 * @param type
	 */
	private void setBorder(RcplCommand command, int type, boolean set) {
		Rcpl.profile();
		// initSelectedObjects();
		// for (JOObject l : JOUtil
		// .getEditor()
		// .getDocument()
		// .getLayoutObjects()
		// .toArray(
		// new JOObject[JOUtil.getEditor().getDocument()
		// .getLayoutObjects().size()])) {
		// if (l instanceof JOParagraph) {
		// JOParagraph par = (JOParagraph) l;
		//
		// if (getEditorFigure().getSelectedParagraphFigure()
		// .getParagraph() != par
		// && !par.getFigure().hasSelection()) {
		// continue;
		// }
		//
		// if (par.getXmlObject() instanceof CTP) {
		// CTP ctp = (CTP) par.getXmlObject();
		// if (set) {
		// CTPPr ppr;
		// if (!ctp.isSetPPr()) {
		// ppr = ctp.addNewPPr();
		// } else {
		// ppr = ctp.getPPr();
		// }
		// CTPBdr pbdr = ppr.isSetPBdr() ? ppr.getPBdr() : ppr
		// .addNewPBdr();
		// switch (type) {
		// case SWT.BOTTOM:
		// createBorder(type, pbdr);
		// break;
		// case SWT.TOP:
		// createBorder(type, pbdr);
		// break;
		// case SWT.LEFT:
		// createBorder(type, pbdr);
		// break;
		// case SWT.RIGHT:
		// createBorder(type, pbdr);
		// break;
		// case SWT.ALL:
		// createBorder(SWT.TOP, pbdr);
		// createBorder(SWT.BOTTOM, pbdr);
		// createBorder(SWT.LEFT, pbdr);
		// createBorder(SWT.RIGHT, pbdr);
		// break;
		// }
		// } else {
		// if (ctp.isSetPPr() && ctp.getPPr().isSetPBdr()) {
		// switch (type) {
		// case SWT.BOTTOM:
		// deleteBorder(type, ctp.getPPr().getPBdr());
		// break;
		// case SWT.TOP:
		// deleteBorder(type, ctp.getPPr().getPBdr());
		// break;
		// case SWT.LEFT:
		// deleteBorder(type, ctp.getPPr().getPBdr());
		// break;
		// case SWT.RIGHT:
		// deleteBorder(type, ctp.getPPr().getPBdr());
		// break;
		// case SWT.ALL:
		// deleteBorder(SWT.TOP, ctp.getPPr().getPBdr());
		// deleteBorder(SWT.BOTTOM, ctp.getPPr().getPBdr());
		// deleteBorder(SWT.LEFT, ctp.getPPr().getPBdr());
		// deleteBorder(SWT.RIGHT, ctp.getPPr().getPBdr());
		// break;
		// }
		// }
		// }
		// }
		// par.setDirty(true);
		// par.updateFromXml();
		// JOParagraphFigure figure = par.getFigure();
		// figure.markAllCharactersDirty();
		// figure.repaint();
		// createChangeCommand(par, command.getEntry());
		// finalizeCommand();
		// }
		// }
		//
		// finalizeSelectedObjects();
		//
		// // if (firstPar != null) {
		// // editorFigure.setDirtyLayout(firstPar);
		// // }
		//
		// JO.profileEnd();
	}

	/**
	 * @param type
	 * @param pbdr
	 */
	private void createBorder(int type, CTPBdr pbdr) {

		int index = 1; // JOUtil2.getComboGuiState("word/actions/object/line_width");
						// //$NON-NLS-1$
		double w = 1;
		switch (index) {

		case 0:
			w = 0.25;
			break;
		case 1:
			w = 0.5;
			break;
		case 2:
			w = 0.75;
			break;
		case 3:
			w = 1;
			break;
		case 4:
			w = 1.5;
			break;
		case 5:
			w = 2.25;
			break;
		case 6:
			w = 3;
			break;
		case 7:
			w = 4.25;
			break;
		case 8:
			w = 6;
			break;
		}

		CTBorder border = null;
		switch (type) {
		case Rcpl.TOP:
			border = pbdr.isSetTop() ? pbdr.getTop() : pbdr.addNewTop();
			break;
		case Rcpl.BOTTOM:
			border = pbdr.isSetBottom() ? pbdr.getBottom() : pbdr.addNewBottom();
			break;
		case Rcpl.LEFT:
			border = pbdr.isSetLeft() ? pbdr.getLeft() : pbdr.addNewLeft();
			break;
		case Rcpl.RIGHT:
			border = pbdr.isSetRight() ? pbdr.getRight() : pbdr.addNewRight();
			break;
		}
		if (border != null) {
			border.setSpace(BigInteger.valueOf(1));
			border.setSz(BigInteger.valueOf((long) (w * 12)));
			// border.setColor(JO.colorProvider.getBytesFromCOLOR(getEditor()
			// .getActualForgroundColor()));

		}
	}

	private void deleteBorder(int type, CTPBdr pbdr) {
		switch (type) {
		case Rcpl.TOP:
			if (pbdr.isSetTop()) {
				pbdr.unsetTop();
			}
			break;
		case Rcpl.BOTTOM:
			if (pbdr.isSetBottom()) {
				pbdr.unsetBottom();
			}
			break;
		case Rcpl.LEFT:
			if (pbdr.isSetLeft()) {
				pbdr.unsetLeft();
			}
			break;
		case Rcpl.RIGHT:
			if (pbdr.isSetRight()) {
				pbdr.unsetRight();
			}
			break;
		}
	}

}
